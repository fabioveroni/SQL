-- Code developed by Fábio Veroni
-- TAX INVOICES ISSUED DURING THE MONTH AND NOT PAID


-- CODE UPDATE
---- FABIO VERONI - 16/05/2023 - NOMEAÇÃO DE CAMPOS/POSIÇÕES E ALTERAÇÃO DE REGRA DE CAMPOS (100, 114, 128, 142, 156, 170)
                  -- 05/16/2023 - APPOINTMENT OF FIELDS/POSITIONS AND CHANGE OF FIELD RULES (100, 114, 128, 142, 156, 170)
 
Select DISTINCT
-- RE.ESTNCODIGO,
    (0) AS ORIGEM_P1,
    (3) AS TIPO_P2,
    CASE WHEN 
        RF.CGC_CPF IS NULL THEN TO_CHAR ('00000000000000')
    ELSE 
        LPAD(translate(RF.CGC_CPF,' .-/', ' '),14,'0')
    END AS CGC_CPF_P3,
    CASE WHEN
        RF.MOEDA='R' THEN RE.ESTCSIGLA  -- Ajustar Para ter 2 digitos. Aguardar resposta Rosângela.
    ELSE
        'EX'
    END AS UF_P17,
    CASE WHEN
        RF.INSC_ESTADUAL='Isenta' or RF.INSC_ESTADUAL IS NULL THEN ('00000000000000000000')
    ELSE
        LPAD(translate(RF.INSC_ESTADUAL,' .-/', ' '),20,'0') 
    END AS IE_P19,
    -- LPAD(NF.SERIE,6,'0') AS SERIE,
    ('%%%%%%') AS SERIE_P39,
    ('%%%%%%') AS SUBSERIE_P45,    
    LPAD(NF.NUMERO_NFE,10,'0') AS NUMERONF_P51,
    ('000') AS DESD_P61,
    translate(TO_CHAR(NF.DATAEMISSAO_NFE,'DD/MM/YYYY'),' .-/', ' ') AS DATA_EMISSAO_P64,
   
    
    -- EDIÇÃO AJUSTE SOLICITACAO CONTABILIDADE - 23/02/2022  -- ACCOUNTING REQUEST ADJUSTMENT EDITION - 02/23/2022
    CASE WHEN 
        FCAR.CRCCPARCELA IS NULL  THEN LPAD((RF.NUMERO || '-' || 1) ,20,'0')
    ELSE
        LPAD((RF.NUMERO || '-' || FCAR.CRCCPARCELA) ,20,'0')
    END AS NUFATURA_P72,
     -- LPAD(RF.NUMERO,20,'0') AS NUFATURA,
    
    -- ('31122030') AS VENCIMENTO,
     CASE WHEN  
       translate(TO_CHAR(add_months(SYSDATE,-1),'MM/YYYY'),' .-/', ' ') = translate(TO_CHAR(RF.DATA_VENC,'MM/YYYY'),' .-/', ' ')
                
      -- TESTE DE VENCIMENTO -- EXPIRY DATE TEST
      /*
        select
        translate(TO_CHAR(add_months(SYSDATE,-1),'MM/YYYY'),' .-/', ' ') -- = translate(TO_CHAR(RF.DATA_VENC,'MM/YYYY'),' .-/', ' ')
        from dual
       */
        
       -- THEN ('31122021') -- select add_months(SYSDATE,-1) from dual
        THEN ('31122030') --|| translate(TO_CHAR(SYSDATE,'YYYY'),' .-/', ' ')
        ELSE translate(TO_CHAR(RF.DATA_VENC,'DD/MM/YYYY'),' .-/', ' ')  
        END AS DATA_VENC_P92,
      -- translate(TO_CHAR(RF.DATA_VENC,'DD/MM/YYYY'),' .-/', ' ') AS DATA_VENC, 
    -- LPAD(TO_NUMBER(REPLACE(TO_CHAR(NF.HONOR,'99999999999999D99'),',',''),'99999999999999'),14,'0') AS VAL_BRUTO, -- Colocar Mascara 
    
    -- 17/05/2023 - FABIO VERONI - ALTERADO O TRATAMENTO CONFORME A MOEDA (NACIONAL OU ESTRANGEIRA) DO RECEBIMENTO/COBRANÇA    
    -- LPAD(REPLACE(TO_CHAR(NF.HONOR,'FM999999999D90'),',','.') ,14,'0')   AS VAL_BRUTO_P100, 
    CASE WHEN
         RF.MOEDA='R' THEN LPAD(REPLACE(TO_CHAR(FCAR.CRCNVALORHONORARIO,'FM999999999D90'),',','.') ,14,'0')
   ELSE     
        LPAD(REPLACE(TO_CHAR(NF.HONOR,'FM999999999D90'),',','.') ,14,'0')      
   END AS VAL_BRUTO_P100, 
    
    -- LPAD(TO_NUMBER(REPLACE(TO_CHAR(NF.IRRF,'99999999999999D99'),',',''),'99999999999999'),14,'0') AS IRRF,
    LPAD(REPLACE(TO_CHAR(NF.IRRF,'FM999999999D90'),',','.') ,14,'0')   AS IRRF_P114, 
    
   --regexp_replace(replace(LPAD(NF.IRRF, 11,'0'),',',''),'([0-9]{2})([0-9]{3})([0-9]{3})','\1.\2.\3.') as teste, -- 99.999.999.999
    
    -- regexp_replace(LPAD('00000000191', 11),'([0-9]{3})([0-9]{3})([0-9]{3})','\1.\2.\3-') as CPF from dual;
    
   -- LPAD(TO_NUMBER(REPLACE(TO_CHAR(NF.PIS,'99999999999999D99'),',',''),'99999999999999'),14,'0') AS PIS,
   -- 17/05/2023 - FABIO VERONI - ALTERADO O CAMPO DE PIS QUE VINHA DA TABELA RCR.NOTAFISCAL PARA O CAMPO CRCNVALORPIS DA TABELA FINANCE.CONTASRECEBER
   -- LPAD(REPLACE(TO_CHAR(NF.PIS,'FM999999999D90'),',','.') ,14,'0')   AS PIS_P128,
   
   LPAD(REPLACE(TO_CHAR(FCAR.CRCNVALORPIS,'FM999999999D90'),',','.') ,14,'0')   AS PIS_P128,
      
    -- LPAD(TO_NUMBER(REPLACE(TO_CHAR(NF.COFINS,'99999999999999D99'),',',''),'99999999999999'),14,'0') AS COFINS,
    -- 17/05/2023 - FABIO VERONI - ALTERADO O CAMPO DE COFINS QUE VINHA DA TABELA RCR.NOTAFISCAL PARA O CAMPO CRCBVALORCOFINS DA TABELA FINANCE.CONTASRECEBER
    -- LPAD(REPLACE(TO_CHAR(NF.COFINS,'FM999999999D90'),',','.') ,14,'0')   AS COFINS_P142,
    LPAD(REPLACE(TO_CHAR(FCAR.CRCNVALORCOFINS,'FM999999999D90'),',','.') ,14,'0')   AS COFINS_P142,
    
    
    -- LPAD(TO_NUMBER(REPLACE(TO_CHAR(NF.CSLL,'99999999999999D99'),',',''),'99999999999999'),14,'0') AS CSLL,
    -- 17/05/2023 - FABIO VERONI - ALTERADO O CAMPO DE  CSLL QUE VINHA DA TABELA RCR.NOTAFISCAL PARA O CAMPO CRCNVALORCSLL DA TABELA FINANCE.CONTASRECEBER
    -- LPAD(REPLACE(TO_CHAR(NF.CSLL,'FM999999999D90'),',','.') ,14,'0')   AS CSLL_P156,
    LPAD(REPLACE(TO_CHAR(FCAR.CRCNVALORCSLL,'FM999999999D90'),',','.') ,14,'0')   AS CSLL_P156,   
    
    -- LPAD(TO_NUMBER(REPLACE(TO_CHAR(((((NF.HONOR-NF.IRRF)-NF.PIS)-NF.COFINS)-NF.CSLL),'99999999999999D99'),',',''),'99999999999999'),14,'0') AS VAL_LIQ,
    -- 17/05/2023 - FABIO VERONI - ALTERADA A REGRA DO CAMPO, DANDO TRATAMENTO AO RESULTADO CONFORME O TIPO DE MOEDA DO RECEBIMENTO/COBRANÇA (NACIONAL OU INTERNACIONAL)
    -- LPAD(REPLACE(TO_CHAR(((((NF.HONOR-NF.IRRF)-NF.PIS)-NF.COFINS)-NF.CSLL),'FM999999999D90'),',','.') ,14,'0') AS VAL_LIQ_P170,
      
    CASE WHEN
        RF.MOEDA='R' THEN LPAD(REPLACE(TO_CHAR(((((FCAR.CRCNVALORHONORARIO-NF.IRRF)-FCAR.CRCNVALORPIS)-FCAR.CRCNVALORCOFINS)-FCAR.CRCNVALORCSLL),'FM999999999D90'),',','.') ,14,'0') 
    ELSE    
        LPAD(REPLACE(TO_CHAR(NF.HONOR,'FM999999999D90'),',','.') ,14,'0')
    END AS VAL_LIQ_P170,   
    
   -- FCAR.CRCDRECEBIMENTO,
   -- SYSDATE,
   -- CASE WHEN FCAR.CRCDRECEBIMENTO<=SYSDATE THEN ('2')    ELSE ('1')     AS COMPESACAO,
  --  (SYSDATE,'MM/YYYY'),
    CASE WHEN  
        translate(TO_CHAR(add_months(SYSDATE,-1),'MM/YYYY'),' .-/', ' ') = translate(TO_CHAR(RF.DATA_VENC,'MM/YYYY'),' .-/', ' ')
       -- THEN ('31122021') -- select add_months(SYSDATE,-1) from dual
        THEN ('3112')|| translate(TO_CHAR(SYSDATE,'YYYY'),' .-/', ' ')
        ELSE translate(TO_CHAR(RF.DATA_VENC,'DD/MM/YYYY'),' .-/', ' ')  
        END AS COMPESACAO_P184,
    ('%%%%%%%%%%%') AS COD_CONTABIL_P192,  --- Pos 192
    ('%%%%%%%%') AS DATA_PAG_P203,  
    ('%%%%%%%%') AS DATA_RAZAO_P211,
    ('00000000000.00') AS VAL_PAGO_P219,
    ('%%%%%%%%%%%') AS COD_CONTABIL_PAG_P233,
     
    CASE WHEN
        FCAR.CRCNDESCRECHON=0 OR FCAR.CRCNDESCRECHON<0 OR FCAR.CRCNDESCRECHON IS NULL THEN TO_CHAR('00000000000.00') 
    WHEN               
        RF.MOEDA<>'R' THEN  LPAD(REPLACE(TO_CHAR((FCAR.CRCNDESCRECHON*FCAR.CRCNCOTACAO),'FM999999999D90'),',','.'),14,'0')
    ELSE 
        LPAD(REPLACE(TO_CHAR(FCAR.CRCNDESCRECHON,'FM999999999D90'),',','.'),14,'0')
    END AS JUR_MUL_P244,
     -- ('00000000000') AS COD_CONT_JUR_MUL_P258,
     ('%%%%%%%%%%%') AS COD_CONT_JUR_MUL_P258,
          /*
    CASE WHEN
        FCAR.CRCNDESCRECHON>0 OR FCAR.CRCNDESCRECHON IS NULL THEN TO_CHAR('00000000000000')
    WHEN 
        RF.MOEDA<>'R' THEN  LPAD(TO_NUMBER(REPLACE(TO_CHAR((FCAR.CRCNDESCRECHON*FCAR.CRCNCOTACAO)*(-1),'99999999999999D99'),',',''),'99999999999999'),14,'0')
    ELSE   
        LPAD(TO_NUMBER(REPLACE(TO_CHAR(FCAR.CRCNDESCRECHON*(-1),'99999999999999D99'),',',''),'99999999999999'),14,'0')
    END AS DESCONTO,
    */
     CASE WHEN
        FCAR.CRCNDESCRECHON>0 OR FCAR.CRCNDESCRECHON IS NULL THEN TO_CHAR('00000000000.00')
    WHEN 
        RF.MOEDA<>'R' THEN  LPAD(REPLACE(TO_CHAR((FCAR.CRCNDESCRECHON*FCAR.CRCNCOTACAO)*(-1),'FM999999999D90'),',','.'),14,'0')
    ELSE   
        LPAD(REPLACE(TO_CHAR(FCAR.CRCNDESCRECHON*(-1),'FM999999999D90'),',','.'),14,'0')
    END AS DESCONTO_P269,
   ('%%%%%%%%%%%') AS COD_CONT_DESC_P283,    
    ('000000') AS JUROSAOMES_P294,
    ('S') AS INTEGRA_P300,
   
    -- EDIÇÃO AJUSTE SOLICITACAO CONTABILIDADE - 23/02/2022 -- Verificar BASE CALC está vindo null  -- Check BASE CALC is coming null
    
    -- select     FC.CRCNVALORHONORARIO,  FC.CRCNDESCRECHON, fc.CRCNCOTACAO, Fc.CRCCPARCELA,FC.* from FINANCE.CONTASRECEBER FC where CRCNFATURA='44620'
   
 CASE WHEN FCAR.CRCNVALORHONORARIO IS NULL 
         THEN LPAD(REPLACE(TO_CHAR((NF.HONOR),'FM999999999D90'),',','.'),14,'0') 
         WHEN  RF.MOEDA='R' AND FCAR.CRCNDESCRECHON IS NULL          
         THEN LPAD(REPLACE(TO_CHAR(FCAR.CRCNVALORHONORARIO,'FM999999999D90'),',','.'),14,'0')
         WHEN RF.MOEDA='R' AND FCAR.CRCNDESCRECHON IS NOT NULL
         THEN LPAD(REPLACE(TO_CHAR((FCAR.CRCNVALORHONORARIO - FCAR.CRCNDESCRECHON),'FM999999999D90'),',','.'),14,'0')
         ELSE LPAD(REPLACE(TO_CHAR((NF.HONOR),'FM999999999D90'),',','.'),14,'0')     
    END AS BASE_CALC_P301,
   
    -- LPAD(REPLACE(TO_CHAR((NF.HONOR),'FM999999999D90'),',','.'),14,'0') AS BASE_CALCULO, 
    
    ('1') AS NATUREZA_P315,
    ('%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%') AS PROC_PIS_COFINS_P316,
    CASE WHEN    
        RF.MOEDA='R' THEN  ('01')
    ELSE 
       ('99')
    END AS TIP_PAG_P348,
    CASE WHEN    
        RF.MOEDA='R' THEN  ('%%%%%%%%%%%%%%%%%%%%%%%%%')
    ELSE 
       ('HONORARIOS INTERNACIONAIS') 
    END AS IDIC_PAG_P350    
    
    FROM  RCR.FATURA RF 
    FULL  JOIN RCR.ESTADO RE ON (RF.ESTNCODIGO=RE.ESTNCODIGO)
          INNER JOIN RCR.NOTAFISCAL NF  ON (RF.NUMERO=NF.NUMERO)
          INNER JOIN FINANCE.CONTASRECEBER FCAR ON (RF.NUMERO=FCAR.CRCNFATURA)
          FULL JOIN TEMP_ADI T ON (RF.NUMERO=T.ADINFATURA)
          FULL JOIN FINANCE.LANCAMENTO FL ON (T.ADINLANCAMENTO=FL.LANNCODIG)
  
    WHERE  NF.ORGNCODIG=1
    -- and fcar.crcnfatura=114380 
     AND FCAR.CRCDRECEBIMENTO is null 
     AND NF.DATA_EMISSAO>='01-07-2024'  AND NF.DATA_EMISSAO<'01-08-2024' -- 2020 -- CAMPO DE FILTRO DO ANO DE EMISSÃO
    --- NOTAS RECEBIDAS NO MES 08 
    --AND FCAR.CRCDRECEBIMENTO>='01-08-2021' -- FILTRO SOMENTE PARA AJUSTE DO MÊS 07/2021.
    -- AND NF.DATA_EMISSAO>='01-01-2021'  
    ORDER BY  8
  
  
 
---------------------------------------************************ DRAFT AND TESTING AREA ****************************---------------------------------------------

  -- Pegar o campo NUFATURA sem os zeros a esquerda de uma fatura que tenha o vencimento = 311122030 e substituir ao numero que está após o igual no select abaixo 
  
  -- SELECT * FROM RCR.FATURA WHERE NUMERO=44933
  -- Se o terceiro campo (DATA_VENC) for uma data passada ao atual dia, está correto o tratamento dado pela Query.
  