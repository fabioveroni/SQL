-- Code developed by Fábio Veroni
-- TAX INVOICES CANCELED IN THE MONTH EXCEPT THE MONTH -- NOTAS CANCELADAS NO MES EXCETO O MES

Select DISTINCT
-- RE.ESTNCODIGO,
    (0) AS ORIGEM,
    (3) AS TIPO,
    CASE WHEN 
        RF.CGC_CPF IS NULL THEN TO_CHAR ('00000000000000')
    ELSE 
        LPAD(translate(RF.CGC_CPF,' .-/', ' '),14,'0')
    END AS CGC_CPF,
    CASE WHEN
        RF.MOEDA='R' THEN RE.ESTCSIGLA  -- Ajustar Para ter 2 digitos. Aguardar resposta Rosângela.
    ELSE
        'EX'
    END AS UF,
    CASE WHEN
        RF.INSC_ESTADUAL='Isenta' or RF.INSC_ESTADUAL IS NULL THEN ('00000000000000000000')
    ELSE
        LPAD(translate(RF.INSC_ESTADUAL,' .-/', ' '),20,'0') 
    END AS IE,
    -- LPAD(NF.SERIE,6,'0') AS SERIE,
    ('%%%%%%') AS SERIE,
    ('%%%%%%') AS SUBSERIE,    
    LPAD(NF.NUMERO_NFE,10,'0') AS NUMERONF,
    ('000') AS DESD,
    translate(TO_CHAR(NF.DATAEMISSAO_NFE,'DD/MM/YYYY'),' .-/', ' ') AS DATA_EMISSAO,
    --LPAD(RF.NUMERO,20,'0') AS NUFATURA,
   
   -- EDIÇÃO AJUSTE SOLICITACAO CONTABILIDADE - 23/02/2022
    CASE WHEN 
        FCAR.CRCCPARCELA IS NULL  THEN LPAD((RF.NUMERO || '-' || 1) ,20,'0')
    ELSE
        LPAD((RF.NUMERO || '-' || FCAR.CRCCPARCELA) ,20,'0')
    END AS NUFATURA,
    
    -- FCAR.CRCCPARCELA AS TESTE, 
    translate(TO_CHAR(RF.DATA_VENC,'DD/MM/YYYY'),' .-/', ' ') AS DATA_VENC, 
    -- LPAD(TO_NUMBER(REPLACE(TO_CHAR(NF.HONOR,'99999999999999D99'),',',''),'99999999999999'),14,'0') AS VAL_BRUTO, -- Colocar Mascara 
    LPAD(REPLACE(TO_CHAR(NF.HONOR,'FM999999999D90'),',','.') ,14,'0')   AS VAL_BRUTO, 
    -- LPAD(TO_NUMBER(REPLACE(TO_CHAR(NF.IRRF,'99999999999999D99'),',',''),'99999999999999'),14,'0') AS IRRF,
    LPAD(REPLACE(TO_CHAR(NF.IRRF,'FM999999999D90'),',','.') ,14,'0')   AS IRRF, 
    
   --regexp_replace(replace(LPAD(NF.IRRF, 11,'0'),',',''),'([0-9]{2})([0-9]{3})([0-9]{3})','\1.\2.\3.') as teste, -- 99.999.999.999
    
    -- regexp_replace(LPAD('00000000191', 11),'([0-9]{3})([0-9]{3})([0-9]{3})','\1.\2.\3-') as CPF from dual;
    
   --  LPAD(TO_NUMBER(REPLACE(TO_CHAR(NF.PIS,'99999999999999D99'),',',''),'99999999999999'),14,'0') AS PIS,
    LPAD(REPLACE(TO_CHAR(NF.PIS,'FM999999999D90'),',','.') ,14,'0')   AS PIS,
    -- LPAD(TO_NUMBER(REPLACE(TO_CHAR(NF.COFINS,'99999999999999D99'),',',''),'99999999999999'),14,'0') AS COFINS,
    LPAD(REPLACE(TO_CHAR(NF.COFINS,'FM999999999D90'),',','.') ,14,'0')   AS COFINS,
    -- LPAD(TO_NUMBER(REPLACE(TO_CHAR(NF.CSLL,'99999999999999D99'),',',''),'99999999999999'),14,'0') AS CSLL,
    LPAD(REPLACE(TO_CHAR(NF.CSLL,'FM999999999D90'),',','.') ,14,'0')   AS CSLL,
    -- LPAD(TO_NUMBER(REPLACE(TO_CHAR(((((NF.HONOR-NF.IRRF)-NF.PIS)-NF.COFINS)-NF.CSLL),'99999999999999D99'),',',''),'99999999999999'),14,'0') AS VAL_LIQ,
    LPAD(REPLACE(TO_CHAR(((((NF.HONOR-NF.IRRF)-NF.PIS)-NF.COFINS)-NF.CSLL),'FM999999999D90'),',','.') ,14,'0') AS VAL_LIQ,
   -- FCAR.CRCDRECEBIMENTO,
  -- SYSDATE,
      translate(TO_CHAR(RF.DATA_VENC,'DD/MM/YYYY'),' .-/', ' ') AS COMPESACAO,
   -- ('00000000000') AS COD_CONTABIL,  --- Pos 192
    CASE WHEN
        RF.MOEDA='R' AND FCAR.PCTCNUMEROCONTAREC='100.010.0020' THEN ('000001.0001')
      WHEN
        RF.MOEDA<>'R' AND FCAR.PCTCNUMEROCONTAREC='100.010.0020' THEN ('000001.0003')
      WHEN
        RF.MOEDA='R' AND FCAR.PCTCNUMEROCONTAREC='100.010.0010' THEN ('000001.0002')
      WHEN
        RF.MOEDA<>'R' AND FCAR.PCTCNUMEROCONTAREC='100.010.0010' THEN ('000001.0004')
      WHEN
        FL.CODIGO='R' AND FL.PCTCNUMEROCONTADEST='100.010.0020' THEN ('000001.0001')
      WHEN
        FL.CODIGO<>'R' AND FL.PCTCNUMEROCONTADEST='100.010.0020' THEN ('000001.0003')
      WHEN 
        FL.CODIGO='R' AND FL.PCTCNUMEROCONTADEST='100.010.0010' THEN ('000001.0002')
      WHEN
        FL.CODIGO<>'R' AND FL.PCTCNUMEROCONTADEST='100.010.0010' THEN ('000001.0004')
    ELSE ('%%%%%%%%%%%')     
       END AS COD_CONTABIL,    
    /*
    CASE WHEN  
        RF.MOEDA='R' THEN TO_CHAR('00000000201')
    ELSE 
        TO_CHAR('00000000202')
    END AS COD_CONTABIL,
    */        
    --translate(TO_CHAR(NF.DATA_CANC,'DD/MM/YYYY'),' .-/', ' ') 
    ('%%%%%%%%') AS DATA_PAG, 
    CASE WHEN 
        FCAR.CRCDRECEBIMENTO IS NOT NULL THEN translate(TO_CHAR(FCAR.CRCDRECEBIMENTO,'DD/MM/YYYY'),' .-/', ' ')
    ELSE ('%%%%%%%%')
    END AS DATA_RAZAO,
 
   ('00000000000.00') AS VAL_PAGO,    
    -- ('00000000000') AS COD_CONTAB_PAG,  -- POS 233
    CASE WHEN
        RF.MOEDA='R' AND FCAR.PCTCNUMEROCONTAREC='100.010.0020' THEN ('000001.0001')
      WHEN
        RF.MOEDA<>'R' AND FCAR.PCTCNUMEROCONTAREC='100.010.0020' THEN ('000001.0003')
      WHEN
        RF.MOEDA='R' AND FCAR.PCTCNUMEROCONTAREC='100.010.0010' THEN ('000001.0002')
      WHEN
        RF.MOEDA<>'R' AND FCAR.PCTCNUMEROCONTAREC='100.010.0010' THEN ('000001.0004')
      WHEN
        FL.CODIGO='R' AND FL.PCTCNUMEROCONTADEST='100.010.0020' THEN ('000001.0001')
      WHEN
        FL.CODIGO<>'R' AND FL.PCTCNUMEROCONTADEST='100.010.0020' THEN ('000001.0003')
      WHEN 
        FL.CODIGO='R' AND FL.PCTCNUMEROCONTADEST='100.010.0010' THEN ('000001.0002')
      WHEN
        FL.CODIGO<>'R' AND FL.PCTCNUMEROCONTADEST='100.010.0010' THEN ('000001.0004')
    ELSE  ('%%%%%%%%%%%') 
       END AS COD_CONTABIL_PAG,    
    /*
    CASE WHEN
        FCAR.CRCNDESCRECHON=0 OR FCAR.CRCNDESCRECHON<0 OR FCAR.CRCNDESCRECHON IS NULL THEN TO_CHAR('00000000000000') 
    WHEN               
        RF.MOEDA<>'R' THEN  LPAD(TO_NUMBER(REPLACE(TO_CHAR((FCAR.CRCNDESCRECHON*FCAR.CRCNCOTACAO),'99999999999999D99'),',',''),'99999999999999'),14,'0')
    ELSE 
        LPAD(TO_NUMBER(REPLACE(TO_CHAR(FCAR.CRCNDESCRECHON,'99999999999999D99'),',',''),'99999999999999'),14,'0')
    END AS JUR_MUL, 
    */
    CASE WHEN
        FCAR.CRCNDESCRECHON=0 OR FCAR.CRCNDESCRECHON<0 OR FCAR.CRCNDESCRECHON IS NULL THEN TO_CHAR('00000000000.00') 
    WHEN               
        RF.MOEDA<>'R' THEN  LPAD(REPLACE(TO_CHAR((FCAR.CRCNDESCRECHON*FCAR.CRCNCOTACAO),'FM999999999D90'),',','.'),14,'0')
    ELSE 
        LPAD(REPLACE(TO_CHAR(FCAR.CRCNDESCRECHON,'FM999999999D90'),',','.'),14,'0')
    END AS JUR_MUL,
     -- ('00000000000') AS COD_CONT_JUR_MUL,
     CASE WHEN
        RF.MOEDA='R' AND FCAR.PCTCNUMEROCONTAREC='100.010.0020' THEN ('000001.0001')
      WHEN
        RF.MOEDA<>'R' AND FCAR.PCTCNUMEROCONTAREC='100.010.0020' THEN ('000001.0003')
      WHEN
        RF.MOEDA='R' AND FCAR.PCTCNUMEROCONTAREC='100.010.0010' THEN ('000001.0002')
      WHEN
        RF.MOEDA<>'R' AND FCAR.PCTCNUMEROCONTAREC='100.010.0010' THEN ('000001.0004')
      WHEN
        FL.CODIGO='R' AND FL.PCTCNUMEROCONTADEST='100.010.0020' THEN ('000001.0001')
      WHEN
        FL.CODIGO<>'R' AND FL.PCTCNUMEROCONTADEST='100.010.0020' THEN ('000001.0003')
      WHEN 
        FL.CODIGO='R' AND FL.PCTCNUMEROCONTADEST='100.010.0010' THEN ('000001.0002')
      WHEN
        FL.CODIGO<>'R' AND FL.PCTCNUMEROCONTADEST='100.010.0010' THEN ('000001.0004')
    ELSE  ('%%%%%%%%%%%')      
       END AS COD_CONT_JUR_MUL,
          /*
    CASE WHEN
        FCAR.CRCNDESCRECHON>0 OR FCAR.CRCNDESCRECHON IS NULL THEN TO_CHAR('00000000000000')
    WHEN 
        RF.MOEDA<>'R' THEN  LPAD(TO_NUMBER(REPLACE(TO_CHAR((FCAR.CRCNDESCRECHON*FCAR.CRCNCOTACAO)*(-1),'99999999999999D99'),',',''),'99999999999999'),14,'0')
    ELSE   
        LPAD(TO_NUMBER(REPLACE(TO_CHAR(FCAR.CRCNDESCRECHON*(-1),'99999999999999D99'),',',''),'99999999999999'),14,'0')
    END AS DESCONTO,
    */
     CASE WHEN
        FCAR.CRCNDESCRECHON>0 OR FCAR.CRCNDESCRECHON IS NULL THEN TO_CHAR('00000000000.00')
    WHEN 
        RF.MOEDA<>'R' THEN  LPAD(REPLACE(TO_CHAR((FCAR.CRCNDESCRECHON*FCAR.CRCNCOTACAO)*(-1),'FM999999999D90'),',','.'),14,'0')
    ELSE   
        LPAD(REPLACE(TO_CHAR(FCAR.CRCNDESCRECHON*(-1),'FM999999999D90'),',','.'),14,'0')
    END AS DESCONTO,
    -- ('00000000000') AS COD_CONT_DESC,
    CASE WHEN
        RF.MOEDA='R' AND FCAR.PCTCNUMEROCONTAREC='100.010.0020' THEN ('000001.0001')
      WHEN
        RF.MOEDA<>'R' AND FCAR.PCTCNUMEROCONTAREC='100.010.0020' THEN ('000001.0003')
      WHEN
        RF.MOEDA='R' AND FCAR.PCTCNUMEROCONTAREC='100.010.0010' THEN ('000001.0002')
      WHEN
        RF.MOEDA<>'R' AND FCAR.PCTCNUMEROCONTAREC='100.010.0010' THEN ('000001.0004')
      WHEN
        FL.CODIGO='R' AND FL.PCTCNUMEROCONTADEST='100.010.0020' THEN ('000001.0001')
      WHEN
        FL.CODIGO<>'R' AND FL.PCTCNUMEROCONTADEST='100.010.0020' THEN ('000001.0003')
      WHEN 
        FL.CODIGO='R' AND FL.PCTCNUMEROCONTADEST='100.010.0010' THEN ('000001.0002')
      WHEN
        FL.CODIGO<>'R' AND FL.PCTCNUMEROCONTADEST='100.010.0010' THEN ('000001.0004')
    ELSE  ('%%%%%%%%%%%')       
       END AS COD_CONT_DESC,    
    ('000000') AS JUROSAOMES,
    ('S') AS INTEGRA,
    /*
    CASE WHEN
        RF.MOEDA<>'R' THEN LPAD(TO_NUMBER(REPLACE(TO_CHAR((FCAR.CRCNVALORRECEBIDO * FCAR.CRCNCOTACAO),'99999999999999D99'),',',''),'99999999999999'),14,'0')
    ELSE
        LPAD(TO_NUMBER(REPLACE(TO_CHAR(FCAR.CRCNVALORRECEBIDO,'99999999999999D99'),',',''),'99999999999999'),14,'0')
    END AS BASE_CALCULO,
    */
    /*
    CASE WHEN
        RF.MOEDA<>'R' THEN LPAD(REPLACE(TO_CHAR((FCAR.CRCNVALORRECEBIDO * FCAR.CRCNCOTACAO),'FM999999999D90'),',','.'),14,'0')
    ELSE
        LPAD(REPLACE(TO_CHAR(FCAR.CRCNVALORRECEBIDO,'FM999999999D90'),',','.'),14,'0')  ----- VERIFICAR COM A ROSANGELA (NF.HONOR)
    END AS BASE_CALCULO,
    */
    CASE WHEN FCAR.CRCNVALORHONORARIO IS NULL 
         THEN LPAD(REPLACE(TO_CHAR((NF.HONOR),'FM999999999D90'),',','.'),14,'0') 
         WHEN  RF.MOEDA='R' AND FCAR.CRCNDESCRECHON IS NULL          
         THEN LPAD(REPLACE(TO_CHAR(FCAR.CRCNVALORHONORARIO,'FM999999999D90'),',','.'),14,'0')
         WHEN RF.MOEDA='R' AND FCAR.CRCNDESCRECHON IS NOT NULL
         THEN LPAD(REPLACE(TO_CHAR((FCAR.CRCNVALORHONORARIO - FCAR.CRCNDESCRECHON),'FM999999999D90'),',','.'),14,'0')
         ELSE ('ERRO BASE CALCULO')       
    END AS BASE_CALC,    
       
   -- LPAD(REPLACE(TO_CHAR((NF.HONOR),'FM999999999D90'),',','.'),14,'0') AS BASE_CALCULO,    
    ('1') AS NATUREZA,
    ('%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%') AS PROC_PIS_COFINS,
    CASE WHEN    
        RF.MOEDA='R' THEN  ('01')
    ELSE 
       ('99')
    END AS TIP_PAG,
    CASE WHEN    
        RF.MOEDA='R' THEN  ('%%%%%%%%%%%%%%%%%%%%%%%%%')
    ELSE 
       ('HONORARIOS INTERNACIONAIS') 
    END AS IDIC_PAG    
    
    FROM  RCR.FATURA RF 
    FULL  JOIN RCR.ESTADO RE ON (RF.ESTNCODIGO=RE.ESTNCODIGO)
          FULL JOIN RCR.NOTAFISCAL NF  ON (RF.NUMERO=NF.NUMERO)
          FULL JOIN FINANCE.CONTASRECEBER FCAR ON (RF.NUMERO=FCAR.CRCNFATURA)
          FULL JOIN TEMP_ADI T ON (RF.NUMERO=T.ADINFATURA)
          FULL JOIN FINANCE.LANCAMENTO FL ON (T.ADINLANCAMENTO=FL.LANNCODIG)
  
    WHERE  NF.ORGNCODIG=1
    AND NF.DATA_CANC>='01-07-2024' AND NF.DATA_CANC<'01-08-2024' -- AND NF.DATA_CANC<'01-08-2021'
    -- AND FCAR.CRCDRECEBIMENTO>='01-07-2021' AND FCAR.CRCDRECEBIMENTO<'01-08-2021'
    AND NF.DATA_EMISSAO<'01-07-2024' -- SEMPRE ALTERAR PARA MENOR QUE O MÊS VIGENTE
    -- AND FCAR.CRCDRECEBIMENTO>='01-07-2021' --AND FCAR.CRCDRECEBIMENTO<'01-08-2021'
    AND RF.SITUACAO='C'
    -- AND NF.DATA_EMISSAO>='01-01-2021'  
   -- AND RF.NUMERO=44481
    ORDER BY  11
    
    
    
    
    
    ---------------------------------------************************ DRAFT AND TESTING AREA ****************************---------------------------------------------
  
  -- select * from rcr.notafiscal where numero=44481
 -- SELECT * FROM RCR.FATURA WHERE SITUACAO='C' AND DATA_EMI>='01-07-2021' and numero=44481 0000003639
 
 -- SELECT * FROM RCR.NOTAFISCAL WHERE DATA_CANC>='01-01-2023'
 -- SELECT * FROM RCR.FATURA WHERE NUMERO=114303
 -- SELECT * FROM RCR.FATURA WHERE NUMERO=44246
 -- SELECT  * FROM RCR.NOTAFISCAL WHERE NUMERO=44246
 -- SELECT * FROM RCR.NOTAFISCAL WHERE DATA_CANC>='01-07-2021' 