-- DESENVOLVIDO POR FÁBIO VERONI - 20/06/2021

-- NOTAS RECEBIDAS NO MES

Select DISTINCT
-- RE.ESTNCODIGO,
    (0) AS ORIGEM,
    (3) AS TIPO,
    CASE WHEN 
        RF.CGC_CPF IS NULL THEN TO_CHAR ('00000000000000')
    ELSE 
        LPAD(translate(RF.CGC_CPF,' .-/', ' '),14,'0')
    END AS CGC_CPF,
    CASE WHEN
        RF.MOEDA='R' THEN RE.ESTCSIGLA  -- Ajustar Para ter 2 digitos. Aguardar resposta Rosângela.
    ELSE
        'EX'
    END AS UF,
    CASE WHEN
        RF.INSC_ESTADUAL='Isenta' or RF.INSC_ESTADUAL IS NULL THEN ('00000000000000000000')
    ELSE
        LPAD(translate(RF.INSC_ESTADUAL,' .-/', ' '),20,'0') 
    END AS IE,
    -- LPAD(NF.SERIE,6,'0') AS SERIE,
    ('%%%%%%') AS SERIE,
    ('%%%%%%') AS SUBSERIE,    
    LPAD(NF.NUMERO_NFE,10,'0') AS NUMERONF,
    ('000') AS DESD,
    translate(TO_CHAR(NF.DATAEMISSAO_NFE,'DD/MM/YYYY'),' .-/', ' ') AS DATA_EMISSAO,
    LPAD(RF.NUMERO,20,'0') AS NUFATURA,
    translate(TO_CHAR(RF.DATA_VENC,'DD/MM/YYYY'),' .-/', ' ') AS DATA_VENC, 
    -- LPAD(TO_NUMBER(REPLACE(TO_CHAR(NF.HONOR,'99999999999999D99'),',',''),'99999999999999'),14,'0') AS VAL_BRUTO, -- Colocar Mascara 
    LPAD(REPLACE(TO_CHAR(NF.HONOR,'FM999999999D90'),',','.') ,14,'0')   AS VAL_BRUTO, 
    -- LPAD(TO_NUMBER(REPLACE(TO_CHAR(NF.IRRF,'99999999999999D99'),',',''),'99999999999999'),14,'0') AS IRRF,
    LPAD(REPLACE(TO_CHAR(NF.IRRF,'FM999999999D90'),',','.') ,14,'0')   AS IRRF, 
    
   --regexp_replace(replace(LPAD(NF.IRRF, 11,'0'),',',''),'([0-9]{2})([0-9]{3})([0-9]{3})','\1.\2.\3.') as teste, -- 99.999.999.999
    
    -- regexp_replace(LPAD('00000000191', 11),'([0-9]{3})([0-9]{3})([0-9]{3})','\1.\2.\3-') as CPF from dual;
    
   --  LPAD(TO_NUMBER(REPLACE(TO_CHAR(NF.PIS,'99999999999999D99'),',',''),'99999999999999'),14,'0') AS PIS,
    LPAD(REPLACE(TO_CHAR(NF.PIS,'FM999999999D90'),',','.') ,14,'0')   AS PIS,
    -- LPAD(TO_NUMBER(REPLACE(TO_CHAR(NF.COFINS,'99999999999999D99'),',',''),'99999999999999'),14,'0') AS COFINS,
    LPAD(REPLACE(TO_CHAR(NF.COFINS,'FM999999999D90'),',','.') ,14,'0')   AS COFINS,
    -- LPAD(TO_NUMBER(REPLACE(TO_CHAR(NF.CSLL,'99999999999999D99'),',',''),'99999999999999'),14,'0') AS CSLL,
    LPAD(REPLACE(TO_CHAR(NF.CSLL,'FM999999999D90'),',','.') ,14,'0')   AS CSLL,
    -- LPAD(TO_NUMBER(REPLACE(TO_CHAR(((((NF.HONOR-NF.IRRF)-NF.PIS)-NF.COFINS)-NF.CSLL),'99999999999999D99'),',',''),'99999999999999'),14,'0') AS VAL_LIQ,
    LPAD(REPLACE(TO_CHAR(((((NF.HONOR-NF.IRRF)-NF.PIS)-NF.COFINS)-NF.CSLL),'FM999999999D90'),',','.') ,14,'0') AS VAL_LIQ,
   -- FCAR.CRCDRECEBIMENTO,
  -- SYSDATE,
   
    -- CASE WHEN FCAR.CRCDRECEBIMENTO<=SYSDATE THEN ('2')    ELSE ('1')     AS COMPESACAO,
      
    translate(TO_CHAR(FCAR.CRCDRECEBIMENTO,'DD/MM/YYYY'),' .-/', ' ') AS COMPESACAO,
      
   -- ('00000000000') AS COD_CONTABIL,  --- Pos 192
    CASE WHEN
        RF.MOEDA='R' AND FCAR.PCTCNUMEROCONTAREC='100.010.0020' THEN ('000001.0001')
      WHEN
        RF.MOEDA<>'R' AND FCAR.PCTCNUMEROCONTAREC='100.010.0020' THEN ('000001.0003')
      WHEN
        RF.MOEDA='R' AND FCAR.PCTCNUMEROCONTAREC='100.010.0010' THEN ('000001.0002')
      WHEN
        RF.MOEDA<>'R' AND FCAR.PCTCNUMEROCONTAREC='100.010.0010' THEN ('000001.0004')
      WHEN
        FL.CODIGO='R' AND FL.PCTCNUMEROCONTADEST='100.010.0020' THEN ('000001.0001')
      WHEN
        FL.CODIGO<>'R' AND FL.PCTCNUMEROCONTADEST='100.010.0020' THEN ('000001.0003')
      WHEN 
        FL.CODIGO='R' AND FL.PCTCNUMEROCONTADEST='100.010.0010' THEN ('000001.0002')
      WHEN
        FL.CODIGO<>'R' AND FL.PCTCNUMEROCONTADEST='100.010.0010' THEN ('000001.0004')
    ELSE FCAR.PCTCNUMEROCONTAREC       
       END AS COD_CONTABIL,    
    /*
    CASE WHEN 
        RF.MOEDA='R' THEN TO_CHAR('00000000201')
    ELSE 
        TO_CHAR('00000000202')
    END AS COD_CONTABIL,
    */
    translate(TO_CHAR(RF.DATA_PAGTO,'DD/MM/YYYY'),' .-/', ' ') AS DATA_PAG,
    translate(TO_CHAR(RF.DATA_PAGTO,'DD/MM/YYYY'),' .-/', ' ') AS DATA_RAZAO,
     /*
   CASE WHEN    
        RF.MOEDA='R' THEN  LPAD(TO_NUMBER(REPLACE(TO_CHAR(FCAR.CRCNVALORRECEBIDO,'99999999999999D99'),',',''),'99999999999999'),14,'0')
    ELSE 
        LPAD(TO_NUMBER(REPLACE(TO_CHAR((FCAR.CRCNVALORRECEBIDO * FCAR.CRCNCOTACAO),'99999999999999D99'),',',''),'99999999999999'),14,'0')
    END AS VAL_PAGO,
    ('00000000000') AS COD_CONTAB_PAG,
     */ 
    CASE WHEN    
        RF.MOEDA='R' THEN  LPAD(REPLACE(TO_CHAR(FCAR.CRCNVALORRECEBIDO,'FM999999999D90'),',','.'),14,'0')
    ELSE 
       LPAD(REPLACE(TO_CHAR((FCAR.CRCNVALORRECEBIDO * FCAR.CRCNCOTACAO),'FM999999999D90'),',','.'),14,'0')
    END AS VAL_PAGO,
    
    -- ('00000000000') AS COD_CONTAB_PAG,  -- POS 233
    CASE WHEN
        RF.MOEDA='R' AND FCAR.PCTCNUMEROCONTAREC='100.010.0020' THEN ('000001.0001')
      WHEN
        RF.MOEDA<>'R' AND FCAR.PCTCNUMEROCONTAREC='100.010.0020' THEN ('000001.0003')
      WHEN
        RF.MOEDA='R' AND FCAR.PCTCNUMEROCONTAREC='100.010.0010' THEN ('000001.0002')
      WHEN
        RF.MOEDA<>'R' AND FCAR.PCTCNUMEROCONTAREC='100.010.0010' THEN ('000001.0004')
      WHEN
        FL.CODIGO='R' AND FL.PCTCNUMEROCONTADEST='100.010.0020' THEN ('000001.0001')
      WHEN
        FL.CODIGO<>'R' AND FL.PCTCNUMEROCONTADEST='100.010.0020' THEN ('000001.0003')
      WHEN 
        FL.CODIGO='R' AND FL.PCTCNUMEROCONTADEST='100.010.0010' THEN ('000001.0002')
      WHEN
        FL.CODIGO<>'R' AND FL.PCTCNUMEROCONTADEST='100.010.0010' THEN ('000001.0004')
    ELSE FCAR.PCTCNUMEROCONTAREC       
       END AS COD_CONTABIL_PAG,    
    /*
    CASE WHEN
        FCAR.CRCNDESCRECHON=0 OR FCAR.CRCNDESCRECHON<0 OR FCAR.CRCNDESCRECHON IS NULL THEN TO_CHAR('00000000000000') 
    WHEN               
        RF.MOEDA<>'R' THEN  LPAD(TO_NUMBER(REPLACE(TO_CHAR((FCAR.CRCNDESCRECHON*FCAR.CRCNCOTACAO),'99999999999999D99'),',',''),'99999999999999'),14,'0')
    ELSE 
        LPAD(TO_NUMBER(REPLACE(TO_CHAR(FCAR.CRCNDESCRECHON,'99999999999999D99'),',',''),'99999999999999'),14,'0')
    END AS JUR_MUL, 
    */
    CASE WHEN
        FCAR.CRCNDESCRECHON=0 OR FCAR.CRCNDESCRECHON<0 OR FCAR.CRCNDESCRECHON IS NULL THEN TO_CHAR('00000000000.00') 
    WHEN               
        RF.MOEDA<>'R' THEN  LPAD(REPLACE(TO_CHAR((FCAR.CRCNDESCRECHON*FCAR.CRCNCOTACAO),'FM999999999D90'),',','.'),14,'0')
    ELSE 
        LPAD(REPLACE(TO_CHAR(FCAR.CRCNDESCRECHON,'FM999999999D90'),',','.'),14,'0')
    END AS JUR_MUL,
     -- ('00000000000') AS COD_CONT_JUR_MUL,
     CASE WHEN
        RF.MOEDA='R' AND FCAR.PCTCNUMEROCONTAREC='100.010.0020' THEN ('000001.0001')
      WHEN
        RF.MOEDA<>'R' AND FCAR.PCTCNUMEROCONTAREC='100.010.0020' THEN ('000001.0003')
      WHEN
        RF.MOEDA='R' AND FCAR.PCTCNUMEROCONTAREC='100.010.0010' THEN ('000001.0002')
      WHEN
        RF.MOEDA<>'R' AND FCAR.PCTCNUMEROCONTAREC='100.010.0010' THEN ('000001.0004')
      WHEN
        FL.CODIGO='R' AND FL.PCTCNUMEROCONTADEST='100.010.0020' THEN ('000001.0001')
      WHEN
        FL.CODIGO<>'R' AND FL.PCTCNUMEROCONTADEST='100.010.0020' THEN ('000001.0003')
      WHEN 
        FL.CODIGO='R' AND FL.PCTCNUMEROCONTADEST='100.010.0010' THEN ('000001.0002')
      WHEN
        FL.CODIGO<>'R' AND FL.PCTCNUMEROCONTADEST='100.010.0010' THEN ('000001.0004')
    ELSE FCAR.PCTCNUMEROCONTAREC       
       END AS COD_CONT_JUR_MUL,
          /*
    CASE WHEN
        FCAR.CRCNDESCRECHON>0 OR FCAR.CRCNDESCRECHON IS NULL THEN TO_CHAR('00000000000000')
    WHEN 
        RF.MOEDA<>'R' THEN  LPAD(TO_NUMBER(REPLACE(TO_CHAR((FCAR.CRCNDESCRECHON*FCAR.CRCNCOTACAO)*(-1),'99999999999999D99'),',',''),'99999999999999'),14,'0')
    ELSE   
        LPAD(TO_NUMBER(REPLACE(TO_CHAR(FCAR.CRCNDESCRECHON*(-1),'99999999999999D99'),',',''),'99999999999999'),14,'0')
    END AS DESCONTO,
    */
     CASE WHEN
        FCAR.CRCNDESCRECHON>0 OR FCAR.CRCNDESCRECHON IS NULL THEN TO_CHAR('00000000000.00')
    WHEN 
        RF.MOEDA<>'R' THEN  LPAD(REPLACE(TO_CHAR((FCAR.CRCNDESCRECHON*FCAR.CRCNCOTACAO)*(-1),'FM999999999D90'),',','.'),14,'0')
    ELSE   
        LPAD(REPLACE(TO_CHAR(FCAR.CRCNDESCRECHON*(-1),'FM999999999D90'),',','.'),14,'0')
    END AS DESCONTO,
    -- ('00000000000') AS COD_CONT_DESC,
    CASE WHEN
        RF.MOEDA='R' AND FCAR.PCTCNUMEROCONTAREC='100.010.0020' THEN ('000001.0001')
      WHEN
        RF.MOEDA<>'R' AND FCAR.PCTCNUMEROCONTAREC='100.010.0020' THEN ('000001.0003')
      WHEN
        RF.MOEDA='R' AND FCAR.PCTCNUMEROCONTAREC='100.010.0010' THEN ('000001.0002')
      WHEN
        RF.MOEDA<>'R' AND FCAR.PCTCNUMEROCONTAREC='100.010.0010' THEN ('000001.0004')
      WHEN
        FL.CODIGO='R' AND FL.PCTCNUMEROCONTADEST='100.010.0020' THEN ('000001.0001')
      WHEN
        FL.CODIGO<>'R' AND FL.PCTCNUMEROCONTADEST='100.010.0020' THEN ('000001.0003')
      WHEN 
        FL.CODIGO='R' AND FL.PCTCNUMEROCONTADEST='100.010.0010' THEN ('000001.0002')
      WHEN
        FL.CODIGO<>'R' AND FL.PCTCNUMEROCONTADEST='100.010.0010' THEN ('000001.0004')
    ELSE FCAR.PCTCNUMEROCONTAREC       
       END AS COD_CONT_DESC,    
    ('000000') AS JUROSAOMES,
    ('S') AS INTEGRA,
    /*
    CASE WHEN
        RF.MOEDA<>'R' THEN LPAD(TO_NUMBER(REPLACE(TO_CHAR((FCAR.CRCNVALORRECEBIDO * FCAR.CRCNCOTACAO),'99999999999999D99'),',',''),'99999999999999'),14,'0')
    ELSE
        LPAD(TO_NUMBER(REPLACE(TO_CHAR(FCAR.CRCNVALORRECEBIDO,'99999999999999D99'),',',''),'99999999999999'),14,'0')
    END AS BASE_CALCULO,
    */
    /*
    CASE WHEN
        RF.MOEDA<>'R' THEN LPAD(REPLACE(TO_CHAR((FCAR.CRCNVALORRECEBIDO * FCAR.CRCNCOTACAO),'FM999999999D90'),',','.'),14,'0')
    ELSE
        LPAD(REPLACE(TO_CHAR(FCAR.CRCNVALORRECEBIDO,'FM999999999D90'),',','.'),14,'0')  ----- VERIFICAR COM A ROSANGELA (NF.HONOR)
    END AS BASE_CALCULO,
    */
    LPAD(REPLACE(TO_CHAR((NF.HONOR),'FM999999999D90'),',','.'),14,'0') AS BASE_CALCULO,    
    ('1') AS NATUREZA,
    ('%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%') AS PROC_PIS_COFINS,
    CASE WHEN    
        RF.MOEDA='R' THEN  ('01')
    ELSE 
       ('99')
    END AS TIP_PAG,
    CASE WHEN    
        RF.MOEDA='R' THEN  ('%%%%%%%%%%%%%%%%%%%%%%%%%')
    ELSE 
       ('HONORARIOS INTERNACIONAIS') 
    END AS IDIC_PAG    
    
    FROM  RCR.FATURA RF 
    
    -- SELECT * FROM RCR.FATURA WHERE NUMERO =44849
    -- SELECT * FROM  RCR.NOTAFISCAL
    
    FULL  JOIN RCR.ESTADO RE ON (RF.ESTNCODIGO=RE.ESTNCODIGO)
          INNER JOIN RCR.NOTAFISCAL NF  ON (RF.NUMERO=NF.NUMERO)           
          INNER JOIN FINANCE.CONTASRECEBER FCAR ON (RF.NUMERO=FCAR.CRCNFATURA)
          FULL JOIN TEMP_ADI T ON (RF.NUMERO=T.ADINFATURA)
          FULL JOIN FINANCE.LANCAMENTO FL ON (T.ADINLANCAMENTO=FL.LANNCODIG)
  
    WHERE  NF.ORGNCODIG=1
    -- and fcar.crcnfatura=114380 
    AND FCAR.CRCDRECEBIMENTO>='01-12-2021' AND FCAR.CRCDRECEBIMENTO<'01-01-2022'
    AND NF.DATA_CANC IS NULL
   --  AND NF.DATA_EMISSAO>='01-01-2021'  AND NF.DATA_EMISSAO<'01-01-2021' -- 2020 -- CAMPO DE FILTRO DO ANO DE EMISSÃO
    -- AND NF.DATA_EMISSAO>='01-01-2021'  
    ORDER BY  8
    
  ----------------------------------------- ÁREA DE TESTE E DESENVOLVIMENTO ---------------------------------------------------    
    
  -- SELECT * FROM FINANCE.CONTASRECEBER WHERE CRCNFATURA='44630'  
  
  -- SELECT NUMERONF, NUMERO_NFE FROM RCR.NOTAFISCAL ORDER BY 1 
  -- WHERE NUMERONF=3701 
  -- NUMERONF, NUMERO_NFE,
  -- where FCAR.CRCNVALORRECEBIDO<0
 --  and nf.orgncodig=2 

    --WHERE NF.DATA_EMISSAO>='01-05-2021' AND NF.DATA_EMISSAO<'01-06-2021' -- Inserir aqui o Intervalo de Datas
    -- and FCAR.CRCNVALORRECEBIDO<0
      
 -- WHERE RF.MOEDA<>'R'
      --  select * from RCR.NOTAFISCAL  where numeronf=3570
        -- select  * from FINANCE.CONTASRECEBER WHERE  crcnnotafiscal= 3570
     /*-- SELECT * FROM RCR.FATURA
      select to_char(12131.1, 'FM999G999G999D90', 'nls_numeric_characters='',.''')
from   dual
       SELECT regexp_replace(LPAD('00000000191', 11),'([0-9]{3})([0-9]{3})([0-9]{3})','\1.\2.\3.') as CPF from dual;
        select to_char(19,'99999999999999D99') from dual;
       --  where nf.serie<>'A' and nf.serie<>'1'
    */
 --   SELECT TO_DATE(TO_CHAR(sysdate, 'DD/MM/YYYY'), 'DD/MM/YYYY') AS data_formatada FROM tabela
  
 -- SELECT * FROM    FINANCE.CONTASRECEBER where CRCNFATURA=114380       PCTCNUMEROCONTAREC='400.010.0010' ORDER BY CRCNFATURA     AND PCTCNUMEROCONTAREC<>'010.010.0020'
--SELECT * FROM RCR.NOTAFISCAL where numero=20216
--SELECT * FROM RCR.FATURA where numero=20216
-- select * /*ESTNCODIGO*/  from RCR.FATURA
-- INNER OUTER JOIN Tabela_B b
-- SELECT * FROM RCR.ESTADO

-- select nf.numero, rf.numero, rf.* from RCR.FATURA RF JOIN RCR.NOTAFISCAL NF  ON (RF.NUMERO=NF.NUMERO)
------------------------------------------CAMPO TESTE E CONSULTA------------------
/*

lpad('tech', 8, '0'); retorna '0000tech'
SELECT
     CASE WHEN CAMPO1 IS NULL THEN 'CAMPO1 NULL' 
       ELSE CAMPO1 END AS CAMPO1, 
     CAMPO2, 
     CAMPO3, 
     CAMPO4, 
     CAMPO5
FROM TABELA1
WHERE CAMPO1 = dado1 AND CAMPO2 = dado2


--------------------------

select translate('123.456.789-01',' .-', ' ')
/* 
DROP TABLE TEMP_ADI

COMMIT

CREATE TABLE TEMP_ADI AS
SELECT * FROM RCR.ADIANTAMENTO ORDER BY 1

UPDATE TEMP_ADI T INNER JOIN RCR.ADIANTAMENTO RCR
                ON T.ADINDOCUMENTO= RCR.ADINDOCUMENTO
        SET T.ADINLANCAMENTO=RCR.ADINLANCAMENTO
WHERE T.ADINLANCAMENTO IS NULL
AND T.ADINDOCUTIL=RCR.ADINDOCUMENTO


SELECT 


UPDATE TEMP_ADI 
SET 
T.ADINLANCAMENTO=RCR.ADINLANCAMENTO
FROM TEMP_ADI T
INNER JOIN RCR.ADIANTAMENTO RCR
ON T.ADINDOCUMENTO= RCR.ADINDOCUMENTO
WHERE T.ADINLANCAMENTO IS NULL
AND T.ADINDOCUTIL=RCR.ADINDOCUMENTO


SET ADINLANCAMENTO=ADINLANCAMENTO
WHERE ADINLANCAMENTO IS NULL
AND ADINDOCUTIL=ADINDOCUMENTO

--- NUMERO_NFE

SELECT R.ADINLANCAMENTO
FROM RCR.ADIANTAMENTO R 
FULL JOIN TEMP_ADI T ON T.ADINDOCUMENTO=R.ADINDOCUMENTO
WHERE T.ADINDOCUTIL=R.ADINDOCUMENTO
ORDER BY 1

SELECT T.ADINDOCUMENTO, T.ADINDOCUTIL, T.ADINFATURA, T.ADINLANCAMENTO FROM TEMP_ADI T  WHERE T.ADINDOCUTIL IS NOT NULL ORDER BY 2

SELECT T.ADINDOCUMENTO, T.ADINDOCUTIL, T.ADINFATURA, T.ADINLANCAMENTO FROM TEMP_ADI T ORDER BY 2
T WHERE ADINLANCAMENTO IS NULL ORDER BY 4

SELECT * FROM TEMP_ADI T
FULL JOIN RCR.ADIANTAMENTO R
ON T.ADINDOCUMENTO=R.ADINDOCUMENTO
WHERE   R.ADINDOCUMENTO=1124 OR T.ADINDOCUTIL=1124 ORDER BY 1

SELECT * FROM TEMP_ADI T
JOIN RCR.ADIANTAMENTO R
ON R.ADINDOCUMENTO=T.ADINDOCUTIL
WHERE   R.ADINDOCUMENTO=5289 OR T.ADINDOCUTIL=5289

SELECT * FROM TEMP_ADI T
JOIN RCR.ADIANTAMENTO R
ON R.ADINDOCUMENTO=T.ADINDOCUTIL
WHERE   R.ADINDOCUMENTO=T.ADINDOCUTIL
OR R.ADINDOCUTIL IS NULL
ORDER BY 1

SELECT * FROM RCR.ADIANTAMENTO WHERE ADINDOCUTIL=5289

SELECT * FROM TEMP_ADI WHERE ADINDOCUTIL=5289 OR ADINDOCUMENTO=5289


SELECT * FROM TEMP_ADI WHERE TO_NUMBER(ADINDOCUMENTO,99999999999)=TO_NUMBER(ADINDOCUTIL,99999999999)

SELECT * FROM TEMP_ADI WHERE ADINDOCUMENTO=5289



*/

